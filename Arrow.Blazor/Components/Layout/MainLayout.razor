@using Arrow.Blazor.Configuration
@inherits LayoutComponentBase
@inject IJSRuntime JS
@inject NavigationManager Navigation
@inject ILogger<MainLayout> Logger
@inject IAdminAccessService AdminAccessService

<div class="layout-shell">
    <header class="app-header">
        <div class="brand">
            <a class="brand-link" href="/">Arrow.Blazor</a>
        </div>

        <nav class="primary-nav" aria-label="Primary">
            <NavLink class="nav-link" href="/" Match="NavLinkMatch.All">
                <i class="fa-solid fa-house" aria-hidden="true"></i>
                <span>Home</span>
            </NavLink>
            @if (FeatureToggles.IsFeedbackEnabled)
            {
                <NavLink class="nav-link" href="/contact">
                    <i class="fa-solid fa-comments" aria-hidden="true"></i>
                    <span>Contact Us</span>
                </NavLink>
            }
            @if (AdminAccessService.IsAdmin())
            {
                <NavLink class="nav-link" href="/admin/stats">
                    <i class="fa-solid fa-chart-line" aria-hidden="true"></i>
                    <span>Statistics</span>
                </NavLink>
            }
        </nav>

        <div class="auth-bar">
            <AuthorizeView>
                <Authorized Context="authContext">
                    <div class="user-controls">
                        <span class="user-email">@authContext.User.Identity?.Name</span>
                        <button type="button" class="btn btn-link logout" @onclick="LogoutAsync" disabled="@isLoggingOut">Logout</button>
                        @if (!string.IsNullOrWhiteSpace(errorMessage))
                        {
                            <span class="text-danger auth-error">@errorMessage</span>
                        }
                    </div>
                </Authorized>
                <NotAuthorized>
                    <NavLink class="nav-link alt" href="/login">Login</NavLink>
                </NotAuthorized>
            </AuthorizeView>
        </div>
    </header>

    <main>
        <article class="content px-4">
            @Body
        </article>
    </main>
</div>

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">🗙</span>
</div>

@code {
    private bool isLoggingOut;
    private string? errorMessage;

    private async Task LogoutAsync()
    {
        if (isLoggingOut)
        {
            return;
        }

        isLoggingOut = true;

        try
        {
            errorMessage = null;
            var result = await JS.InvokeAsync<AuthApiResponse>("arrowAuth.logout");
            if (!result.Succeeded)
            {
                errorMessage = string.Join(' ', result.Errors);
                return;
            }

            Navigation.NavigateTo("/", forceLoad: true);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error during logout");
            errorMessage = "Unable to sign out right now.";
        }
        finally
        {
            isLoggingOut = false;
        }
    }
}
